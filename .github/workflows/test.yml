name: Test

on:
  push:
    branches: [ master, develop, 'dev/*', 'claude/*' ]
  pull_request:
    branches: [ master, develop ]

jobs:
  test:
    name: test (${{ matrix.os }}, py-${{ matrix.python_version }})
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash -el {0}
    strategy:
      fail-fast: false
      matrix:
        os: ['ubuntu-22.04', windows-latest, macOS-13]
        python_version: ['3.8']
        include:
          # PsychoPy currently restricted to <= 3.10
          - os: ubuntu-22.04
            python_version: '3.10'

    steps:
    - uses: actions/checkout@v4
    - name: Install APT dependencies
      if: "startsWith(runner.os, 'Linux')"
      run: |
        make install-deps-apt
    - name: Install conda (macOS with osx-64)
      if: matrix.os == 'macOS-13'
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-activate-base: false
        python-version: ${{ matrix.python_version }}
        activate-environment: eeg-expy-full
        channels: conda-forge
        miniconda-version: "latest"
        # Force osx-64 platform for audio support
        conda-build-version: "*"
        environment-file: environments/eeg-expy-full.yml
      env:
        CONDA_SUBDIR: osx-64

    - name: Install conda (Linux/Windows)
      if: matrix.os != 'macOS-13'
      uses: conda-incubator/setup-miniconda@v3
      with:
        environment-file: environments/eeg-expy-full.yml
        auto-activate-base: false
        python-version: ${{ matrix.python_version }}
        activate-environment: eeg-expy-full
        channels: conda-forge
        miniconda-version: "latest"


    - name: Run eegnb install test
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          Xvfb :0 -screen 0 1024x768x24 -ac +extension GLX +render -noreset &> xvfb.log &
          export DISPLAY=:0
        fi
        eegnb --help
        eegnb runexp --help
    - name: Run examples with coverage
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          Xvfb :0 -screen 0 1024x768x24 -ac +extension GLX +render -noreset &> xvfb.log &
          export DISPLAY=:0
        fi
        make test PYTEST_ARGS="--ignore=tests/test_run_experiments.py"


  typecheck:
    name: typecheck (${{ matrix.os }}, py-${{ matrix.python_version }})
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash -el {0}
    strategy:
      fail-fast: false
      matrix:
        os: ['ubuntu-22.04']
        python_version: [3.9]

    steps:
    - uses: actions/checkout@v4
    - name: Install conda
      uses: conda-incubator/setup-miniconda@v3
      with:
        environment-file: environments/eeg-expy-full.yml
        auto-activate-base: false
        python-version: ${{ matrix.python_version }}
        activate-environment: eeg-expy-full
        channels: conda-forge
        miniconda-version: "latest"
    - name: Typecheck
      run: |
        make typecheck
